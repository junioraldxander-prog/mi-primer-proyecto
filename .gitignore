#!/usr/bin/env python3
"""
Script para integrar Coverity Scan en CI/CD
Automatiza la descarga, an√°lisis y env√≠o de resultados a Coverity Scan
"""

import os
import sys
import subprocess
import shutil
import argparse
from pathlib import Path

class CoverityScanCI:
    def __init__(self, project_name, token, email):
        self.project_name = project_name
        self.token = token
        self.email = email
        self.coverity_dir = Path("cov-analysis")
        self.build_dir = Path("cov-int")
        
    def download_coverity_tools(self):
        """Descarga las herramientas de Coverity si no existen"""
        print("üì¶ Verificando herramientas de Coverity...")
        
        if self.coverity_dir.exists():
            print("‚úì Herramientas ya descargadas")
            return True
            
        print("‚¨áÔ∏è  Descargando Coverity Scan Tools...")
        download_url = f"https://scan.coverity.com/download/linux64"
        
        cmd = [
            "wget", download_url,
            "--post-data", f"token={self.token}&project={self.project_name}",
            "-O", "coverity_tool.tar.gz"
        ]
        
        try:
            subprocess.run(cmd, check=True)
            subprocess.run(["tar", "xzf", "coverity_tool.tar.gz"], check=True)
            
            # Renombrar directorio extra√≠do
            extracted = list(Path(".").glob("cov-analysis-linux64-*"))[0]
            extracted.rename(self.coverity_dir)
            
            print("‚úì Herramientas descargadas correctamente")
            return True
        except subprocess.CalledProcessError as e:
            print(f"‚ùå Error descargando herramientas: {e}")
            return False
    
    def run_coverity_build(self, build_command=None):
        """Ejecuta el an√°lisis de Coverity"""
        print("\nüîç Ejecutando an√°lisis de Coverity...")
        
        cov_build = self.coverity_dir / "bin" / "cov-build"
        
        # Comando por defecto para Python
        if not build_command:
            build_command = "python -m py_compile $(find . -name '*.py')"
        
        cmd = [
            str(cov_build),
            "--dir", str(self.build_dir),
            "--no-command",
            "--fs-capture-search", "."
        ]
        
        try:
            # Limpiar build anterior
            if self.build_dir.exists():
                shutil.rmtree(self.build_dir)
            
            subprocess.run(cmd, check=True)
            print("‚úì An√°lisis completado")
            return True
        except subprocess.CalledProcessError as e:
            print(f"‚ùå Error en an√°lisis: {e}")
            return False
    
    def submit_results(self, version="1.0", description="Automated scan"):
        """Env√≠a los resultados a Coverity Scan"""
        print("\nüì§ Enviando resultados a Coverity Scan...")
        
        # Comprimir resultados
        tar_file = f"{self.project_name}.tar.gz"
        subprocess.run(
            ["tar", "czf", tar_file, "-C", ".", "cov-int"],
            check=True
        )
        
        # Enviar a Coverity
        upload_url = f"https://scan.coverity.com/builds?project={self.project_name}"
        
        cmd = [
            "curl", "--form", f"token={self.token}",
            "--form", f"email={self.email}",
            "--form", f"file=@{tar_file}",
            "--form", f"version={version}",
            "--form", f"description={description}",
            upload_url
        ]
        
        try:
            result = subprocess.run(cmd, check=True, capture_output=True, text=True)
            print("‚úì Resultados enviados correctamente")
            print(f"Respuesta: {result.stdout}")
            return True
        except subprocess.CalledProcessError as e:
            print(f"‚ùå Error enviando resultados: {e}")
            print(f"Salida: {e.stderr}")
            return False
    
    def run_full_scan(self, version="1.0", description="CI/CD Scan"):
        """Ejecuta el flujo completo de Coverity"""
        print(f"üöÄ Iniciando Coverity Scan para {self.project_name}\n")
        
        if not self.download_coverity_tools():
            return False
            
        if not self.run_coverity_build():
            return False
            
        if not self.submit_results(version, description):
            return False
        
        print("\n‚úÖ ¬°Scan completado exitosamente!")
        return True


def main():
    parser = argparse.ArgumentParser(
        description="Script de integraci√≥n de Coverity Scan para CI/CD"
    )
    parser.add_argument(
        "--project", 
        required=True,
        help="Nombre del proyecto en Coverity Scan"
    )
    parser.add_argument(
        "--token",
        required=True,
        help="Token de Coverity Scan (o usar variable COVERITY_TOKEN)"
    )
    parser.add_argument(
        "--email",
        required=True,
        help="Email para notificaciones"
    )
    parser.add_argument(
        "--version",
        default=os.getenv("CI_COMMIT_SHA", "1.0")[:8],
        help="Versi√≥n del build (default: commit SHA)"
    )
    parser.add_argument(
        "--description",
        default="Automated CI/CD Scan",
        help="Descripci√≥n del scan"
    )
    
    args = parser.parse_args()
    
    # Permitir token desde variable de entorno
    token = args.token or os.getenv("COVERITY_TOKEN")
    if not token:
        print("‚ùå Error: Se requiere --token o variable COVERITY_TOKEN")
        sys.exit(1)
    
    scanner = CoverityScanCI(args.project, token, args.email)
    success = scanner.run_full_scan(args.version, args.description)
    
    sys.exit(0 if success else 1)


if __name__ == "__main__":
    main()
