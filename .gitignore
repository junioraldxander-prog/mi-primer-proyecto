import re
import os

def analyze_source_code(file_path):
    # Definición de reglas de seguridad (Patrones de vulnerabilidad)
    rules = [
        {
            "id": "SEC-001",
            "name": "Hardcoded API Key",
            "pattern": r'(?i)(api_key|secret|password|token)\s*=\s*["\'][a-zA-Z0-9]{10,}["\']',
            "severity": "HIGH"
        },
        {
            "id": "SEC-002",
            "name": "SQL Injection Risk",
            "pattern": r'\.execute\(f?["\'].*\{.*\}["\']\)',
            "severity": "CRITICAL"
        },
        {
            "id": "SEC-003",
            "name": "Insecure Function (eval)",
            "pattern": r'\beval\(.*\)',
            "severity": "MEDIUM"
        },
        {
            "id": "SEC-004",
            "name": "Insecure Deserialization (pickle)",
            "pattern": r'import\s+pickle|pickle\.loads\(',
            "severity": "HIGH"
        }
    ]

    findings = []

    try:
        with open(file_path, 'r', encoding='utf-8') as file:
            lines = file.readlines()
            
            for line_num, content in enumerate(lines, 1):
                for rule in rules:
                    if re.search(rule["pattern"], content):
                        findings.append({
                            "line": line_num,
                            "rule_id": rule["id"],
                            "issue": rule["name"],
                            "severity": rule["severity"],
                            "code": content.strip()
                        })
    except Exception as e:
        print(f"Error reading {file_path}: {e}")

    return findings

def print_report(findings):
    if not findings:
        print("✅ No se encontraron vulnerabilidades evidentes.")
        return

    print(f"{'LINE':<6} | {'SEVERITY':<10} | {'ISSUE':<25} | {'CODE'}")
    print("-" * 80)
    for f in findings:
        print(f"{f['line']:<6} | {f['severity']:<10} | {f['issue']:<25} | {f['code']}")

# Ejemplo de ejecución
if __name__ == "__main__":
    # Supongamos que analizamos este mismo archivo o uno de prueba
    test_file = "vulnerable_script.py"
    
    # Creamos un archivo de prueba rápido para demostrarlo
    with open(test_file, "w") as f:
        f.write("api_key = 'AIzaSyA123456789'\n")
        f.write("cursor.execute(f'SELECT * FROM users WHERE id = {user_id}')\n")
        f.write("data = eval(input())\n")

    print(f"--- Analizando: {test_file} ---")
    results = analyze_source_code(test_file)
    print_report(results)
